---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: standardising-publish-
  namespace: argo
spec:
  parallelism: 50
  nodeSelector:
    karpenter.sh/capacity-type: "spot"
  entrypoint: main
  synchronization:
    semaphore:
      configMapKeyRef:
        name: semaphores
        key: standardising
  arguments:
    parameters:
      ## The following parameters MUST be specified when submitting (values are examples only)
      # -p source="s3://linz-imagery-staging/test/sample/"
      # -p target="s3://linz-imagery-staging/test/sample_target/"
      # -p title="*Region/District/City* *GSD* *Urban/Rural* Aerial Photos (*Year-Year*)"
      # -p description="Orthophotography within the *Region Name* region captured in the *Year*-*Year* flying season."
      # -p start-datetime="YYYY-MM-DD"
      # -p end-datetime="YYYY-MM-DD"
      # -p scale=""

      ## The cutline parameter CAN be specified when submitting (value is example only)
      # -p cutline="s3://linz-imagery-staging/test/sample/sample_cutline.fgb"

      ## The following parameters CAN be specified when submitting to override the defaults below
      - name: copy-option
        value: "--no-clobber"
      - name: include
        value: ".tiff?$"
      - name: publish-copy-option
        value: "--no-clobber"
      - name: publish-include
        value: ".tiff?$|.json$"
      - name: compression
        value: "webp"
      - name: version-argo-tasks
        value: "v2"
      - name: version-basemaps-cli
        value: "v6"
      - name: version-topo-imagery
        value: "v0"
      - name: group
        value: 50
      - name: publish-version-argo-tasks
        value: "v2"

  templates:
    - name: main
      steps:
        - - name: standardise
            templateRef:
              name: imagery-standardising-v1
              template: main
        - - name: publish
            templateRef:
              name: publish-copy-v1
              template: main
            arguments:
              parameters:
                - name: version-argo-tasks
                  value: "{{workflow.parameters.publish-version-argo-tasks}}"
                - name: source
                  value: "{{steps.standardise.outputs.parameters.target}}flat/"
                - name: target
                  value: "{{workflow.parameters.target}}"
                - name: include
                  value: "{{workflow.parameters.publish-include}}"
                - name: copy-option
                  value: "{{workflow.parameters.publish-copy-option}}"
  volumes:
    - name: ephemeral
      emptyDir: {}
